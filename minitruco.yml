---
- hosts: production
  remote_user: "{{ admin_user }}"

  handlers:
    - name: reload supervisor # without restarting other supervised apps
      shell: "supervisorctl update; supervisorctl reread"
      become: yes

    - name: restart app
      shell: "supervisorctl restart minitruco"
      become: yes

  roles:
    - role: chesterbr.vault
  tasks:
    - name: Install prereq packages
      apt: name={{ packages }} state=present
      become: yes
      vars:
        packages:
          - git
          - default-jdk
          - supervisor

    - name: Ensure code repository is at latest version
      git: repo=https://github.com/chesterbr/minitruco-android.git
           accept_hostkey=true
           dest={{ minitruco_checkout_dir }}
           version=main
      notify: restart app
      tags:
        - update_app

    - name: Ensures application directory exists
      file:
        path: "{{ minitruco_app_dir }}"
        state: directory
        owner: "{{ server_user }}"
        group: "{{ server_user }}"
      become: yes

    - name: Copy the server JAR with proper permissions
      copy:
        remote_src: yes
        src: "{{ minitruco_checkout_dir }}/server/deploy/server.jar"
        dest: "{{ minitruco_app_dir }}/server.jar"
        owner: "{{ server_user }}"
        group: "{{ server_user }}"
      become: yes
      notify: restart app
      tags:
        - update_app

    - name: Configure app to run under supervisor (from source dir)
      template: src=templates/minitruco.conf.supervisor.j2 dest=/etc/supervisor/conf.d/minitruco.conf
      become: yes
      notify: reload supervisor
